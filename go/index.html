<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inscription — Your New Agent</title>

<!-- Supabase JS v2 (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body{font-family:Inter,system-ui,Arial,sans-serif;background:#f6f7fb;color:#1f2d3d;margin:0;padding:20px}
  .card{max-width:520px;margin:40px auto;background:white;border-radius:10px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,0.06);border:1px solid #e6e9ef}
  h1{margin:0 0 12px 0}
  label{display:block;font-size:13px;margin-top:10px;color:#34495e}
  input{width:100%;padding:10px;border-radius:8px;border:1px solid #cfd8e3;margin-top:6px;font-size:14px}
  .btn{margin-top:14px;padding:10px 14px;border-radius:8px;border:0;background:#1179cf;color:white;font-weight:700;cursor:pointer}
  .small{font-size:13px;color:#6b7b8d;margin-top:8px}
  .error{color:#9b2c2c;margin-top:8px}
  .info{color:#2b6aeb;margin-top:8px}
  .muted{font-size:12px;color:#718096}
</style>
</head>
<body>
  <div class="card" role="main">
    <h1>Créer un compte</h1>
    <p class="small">Entrez votre email et un mot de passe. Compte par défaut : <strong>Free</strong> (limite 2 ressources).</p>

    <!-- FORM -->
    <form id="signupForm" autocomplete="on">
      <label for="email">Email</label>
      <input id="email" name="email" type="email" placeholder="votre@exemple.com" required/>

      <label for="password">Mot de passe</label>
      <input id="password" name="password" type="password" placeholder="Mot de passe sécurisé" minlength="6" required/>

      <button id="signup" type="submit" class="btn">S'inscrire</button>
    </form>

    <div id="msg" class="small muted" role="status" aria-live="polite"></div>

    <hr style="margin:18px 0"/>

    <p class="muted">Après création et connexion, vous serez redirigé automatiquement vers <code>/try</code> pour gérer vos ressources (Free = max 2).</p>
    <p class="muted">Si votre projet demande confirmation par e-mail, confirmez d'abord le mail reçu.</p>
  </div>

<script>
/* ====== CONFIG: Remplace par tes valeurs Supabase ====== */
const SUPABASE_URL = 'https://qjmqmcwoprhzzevpiytx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqbXFtY3dvcHJoenpldnBpeXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNjk0ODksImV4cCI6MjA3Nzg0NTQ4OX0.fx7-ije0ghFr5fZoeFB6DtQBxcYov1jbvshRQ5TtiQY';

/* ====================================================== */

/* create supabase client — note: CDN exposes global `supabase` object */
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, detectSessionInUrl: true }
});

/* UI refs */
const signupForm = document.getElementById('signupForm');
const emailEl = document.getElementById('email');
const passEl = document.getElementById('password');
const signupBtn = document.getElementById('signup');
const msg = document.getElementById('msg');

/* helper to show messages */
function showMsg(text, type='info'){
  msg.className = type === 'error' ? 'error' : (type === 'info' ? 'info' : 'small muted');
  msg.innerHTML = text;
}

/* create or upsert profile (id = auth.user.id) */
async function ensureProfileForUser(user){
  try{
    const payload = {
      id: user.id,
      email: user.email,
      plan: 'Free',
      created_at: new Date().toISOString()
    };
    // upsert: if exists, won't duplicate
    const { data, error } = await supabase.from('profiles').upsert(payload, { onConflict: 'id' });
    if(error){
      console.warn('profiles upsert error', error);
      return { ok:false, error };
    }
    return { ok:true, data };
  }catch(e){
    console.error('ensureProfileForUser error', e);
    return { ok:false, error: e };
  }
}

/* Redirect helper: navigate to /try after successful sign-up and profile creation */
function goToTry(){
  // change location to /try — adapte si route différente
  window.location.href = '/try';
}

/* Listen to auth state changes: when user signs up & a session exists, create profile and redirect */
supabase.auth.onAuthStateChange(async (event, session) => {
  console.log('auth event', event, session);
  if(session && session.user){
    // user authenticated — ensure profile exists
    showMsg('Utilisateur connecté. Préparation du profil...', 'info');
    const res = await ensureProfileForUser(session.user);
    if(res.ok){
      showMsg('Profil prêt — redirection...', 'info');
      // short delay pour UX
      setTimeout(goToTry, 600);
    }else{
      showMsg('Erreur lors de la création du profil. Voir console.', 'error');
      console.error(res.error);
    }
  } else {
    // logged out or no session
    console.log('no session or logged out');
  }
});

/* Handle form submit => signUp */
signupForm.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  signupBtn.disabled = true;
  showMsg('Création du compte en cours...', 'info');

  const email = emailEl.value.trim();
  const password = passEl.value;
  if(!email || !password){ showMsg('Email et mot de passe requis.', 'error'); signupBtn.disabled = false; return; }

  try{
    // signUp: returns { data, error }
    const { data, error } = await supabase.auth.signUp({ email, password }, { redirectTo: window.location.origin + '/try' });
    if(error){
      // signUp can return an error (weak password, duplicate, etc.)
      console.error('signUp error', error);
      showMsg('Erreur inscription : ' + (error.message || error), 'error');
      signupBtn.disabled = false;
      return;
    }

    // data.user might be null if email confirmation flow is active: user must confirm before session exists
    // We rely on onAuthStateChange listener above to create profile + redirect when session becomes available.
    console.log('signUp data', data);

    if(data && data.user){
      // If user is auto-signed-in, onAuthStateChange will also run — but we can proactively ensure profile here
      const ensure = await ensureProfileForUser(data.user);
      if(ensure.ok){
        showMsg('Inscription réussie. Redirection...', 'info');
        setTimeout(goToTry, 600);
      } else {
        showMsg('Inscription réussie, mais erreur profil. Voir console.', 'error');
      }
    } else {
      // likely confirmation by email required — inform user
      showMsg('Compte créé. Vérifiez votre email pour confirmer (si demandé). Une fois confirmé, vous serez redirigé vers /try.', 'info');
    }
  }catch(err){
    console.error('signup catch', err);
    showMsg('Erreur inattendue. Voir console.', 'error');
  } finally {
    signupBtn.disabled = false;
  }
});

/* OPTIONAL: convenience — if already logged in, redirect directly */
(async function autoRedirectIfLogged(){
  try{
    const sres = await supabase.auth.getSession();
    const session = sres && sres.data && sres.data.session;
    if(session && session.user){
      // session exists -> ensure profile then redirect
      console.log('Already logged in, ensuring profile and redirecting');
      await ensureProfileForUser(session.user);
      goToTry();
    }
  }catch(e){ console.warn('autoRedirect check failed', e); }
})();
</script>
</body>
</html>
