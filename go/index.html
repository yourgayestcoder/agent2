<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>DEBUG Supabase SignUp</title>
<style>
  body{font-family:Inter,system-ui,Arial,sans-serif;padding:18px;background:#f4f6fb;color:#16202a}
  .card{max-width:900px;margin:18px auto;background:white;padding:16px;border-radius:8px;border:1px solid #e0e6ef}
  label{display:block;margin-top:8px;font-weight:600}
  input,textarea,select{width:100%;padding:8px;border-radius:6px;border:1px solid #cfd8e3;margin-top:6px}
  button{margin-top:10px;padding:8px 12px;border-radius:6px;background:#1179cf;color:#fff;border:0;cursor:pointer}
  pre{background:#0f1720;color:#dbeafe;padding:12px;border-radius:6px;overflow:auto;max-height:280px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .muted{font-size:13px;color:#6b7280}
</style>
</head>
<body>
  <div class="card">
    <h2>Debug Supabase SignUp</h2>
    <p class="muted">Colle ton SUPABASE_URL (ex: https://xyz.supabase.co) et ANON KEY, puis clique "Test signup". La page affichera la réponse de Supabase (status, body) et fera aussi un fetch brut vers /auth/v1/signup.</p>

    <label>SUPABASE_URL</label>
    <input id="supabaseUrl" placeholder="https://qjmqmcwoprhzzevpiytx.supabase.co" />

    <label>SUPABASE ANON KEY</label>
    <input id="anonKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqbXFtY3dvcHJoenpldnBpeXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNjk0ODksImV4cCI6MjA3Nzg0NTQ4OX0.fx7-ije0ghFr5fZoeFB6DtQBxcYov1jbvshRQ5TtiQY" />

    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" value="test@example.com" />
      </div>
      <div>
        <label>Password</label>
        <input id="password" value="Password123!" />
      </div>
    </div>

    <button id="testBtn">Test signUp() using supabase-js</button>
    <button id="directBtn" style="background:#22c55e">Direct fetch to /auth/v1/signup</button>

    <h3>supabase-js result (object)</h3>
    <pre id="jsResult">—</pre>

    <h3>Direct fetch result (/auth/v1/signup)</h3>
    <pre id="fetchResult">—</pre>

    <h3>Network hints</h3>
    <pre id="hints">
1) If fetch returns 401/403 — key invalid or auth endpoint rejects (check anon key).
2) If fetch fails with CORS error in browser console but curl works — browser CORS issue.
3) If signUp returns success but no auth.users row — maybe mail confirmation pending (check your project's Auth settings).
4) Check Supabase Console: Auth -> Users (should list newly created user if signUp succeeded).
    </pre>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const testBtn = document.getElementById('testBtn');
const directBtn = document.getElementById('directBtn');
const jsResult = document.getElementById('jsResult');
const fetchResult = document.getElementById('fetchResult');

function pretty(obj){ try{return JSON.stringify(obj, null, 2);}catch(e){return String(obj);} }

testBtn.addEventListener('click', async ()=>{
  jsResult.textContent = 'Running...';
  const SUPABASE_URL = document.getElementById('supabaseUrl').value.trim();
  const SUPABASE_ANON_KEY = document.getElementById('anonKey').value.trim();
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;

  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){ jsResult.textContent = 'Provide SUPABASE_URL and ANON KEY.'; return; }

  try{
    // create client with different var name to avoid collision
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // call signUp
    const res = await sb.auth.signUp({ email, password });
    jsResult.textContent = pretty(res);
    console.log('supabase-js signUp result', res);
  }catch(err){
    jsResult.textContent = 'Exception: ' + String(err) + '\nSee console.';
    console.error(err);
  }
});

directBtn.addEventListener('click', async ()=>{
  fetchResult.textContent = 'Running direct fetch...';
  const SUPABASE_URL = document.getElementById('supabaseUrl').value.trim();
  const SUPABASE_ANON_KEY = document.getElementById('anonKey').value.trim();
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;

  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){ fetchResult.textContent = 'Provide SUPABASE_URL and ANON KEY.'; return; }

  try{
    const url = SUPABASE_URL.replace(/\/$/, '') + '/auth/v1/signup';
    const body = { email, password };
    const r = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type':'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
      },
      body: JSON.stringify(body)
    });
    const text = await r.text();
    let parsed;
    try{ parsed = JSON.parse(text); } catch(e){ parsed = text; }
    fetchResult.textContent = 'Status: ' + r.status + ' ' + r.statusText + '\n\nHeaders:\n' + Array.from(r.headers.entries()).map(h=>h.join(': ')).join('\n') + '\n\nBody:\n' + (typeof parsed === 'string' ? parsed : JSON.stringify(parsed, null, 2));
    console.log('fetch result', r, parsed);
  }catch(err){
    fetchResult.textContent = 'Fetch exception: ' + String(err) + '\nCheck console for CORS or network errors.';
    console.error(err);
  }
});
</script>
</body>
</html>
