<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Your New Agent — Mini Chat IA</title>

<!-- PDF.js -->
<script src="https://unpkg.com/pdfjs-dist@3.9.179/build/pdf.min.js"></script>

<style>
  :root{
    /* default Ice (appliqué en JS au chargement aussi) */
    --bg: #f5f6fa;
    --accent: #cad0db;
    --secondary: #1179cf;
    --border: #a9b4c7;
    --text: #3b4f73;
    --link: #1179cf;
    --card: #ffffff;
    --contrast-bg: #eef3fb;
    --contrast-border: #d7e1ee;

    --left-w: 30%;
    --right-w: 70%;
    --gap: 12px;
    --avatar-size: 16px;

    font-family: Inter, system-ui, Arial, sans-serif;
    --transition-fast: 160ms;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);}

  /* Top sticky bar */
  header.appbar{
    position:sticky;top:0;left:0;right:0;z-index:120;
    display:flex;align-items:center;justify-content:space-between;
    gap:12px;padding:10px 18px;background:var(--card);
    border-bottom:4px solid var(--border);
    box-shadow:0 2px 6px rgba(0,0,0,0.03);
  }
  .app-title{font-weight:700;font-size:18px;color:var(--text)}
  .appbar .tools{display:flex;gap:8px;align-items:center}

  /* main area */
  .app{display:flex;gap:var(--gap);padding:18px;height:calc(100vh - 64px);box-sizing:border-box;}

  /* left column */
  .col-left{width:var(--left-w);display:flex;flex-direction:column;gap:12px;transition:all var(--transition-fast) ease;}
  .col-left.hidden{display:none;width:0;padding:0;margin:0;opacity:0}
  .panel{background:var(--card);border-radius:8px;padding:12px;box-shadow:0 1px 4px rgba(0,0,0,0.04);overflow:auto;border:1px solid var(--border)}
  .add-wrapper{background:var(--contrast-bg);border:1px solid var(--contrast-border);padding:10px;border-radius:8px;margin-bottom:8px}
  .add-wrapper h4{margin:0 0 8px 0;color:var(--text)}
  .add-resource-form{display:flex;flex-direction:column;gap:8px;}
  label.small{font-size:13px;color:var(--text)}
  input[type="text"], textarea {padding:8px;border:1px solid var(--border);border-radius:6px;font-size:14px;width:100%;box-sizing:border-box;background:transparent;color:var(--text)}
  textarea{min-height:80px;resize:vertical}
  .resource-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .resource-item{border:1px dashed var(--border);padding:8px;border-radius:6px;display:flex;flex-direction:column;gap:6px;background:transparent;}
  .meta{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text)}
  .tag{background:transparent;color:var(--link);padding:4px 8px;border-radius:999px;font-weight:600;border:1px solid var(--border)}

  /* tag clouds (no dropdowns) */
  .tag-cloud{display:flex;flex-wrap:wrap;gap:8px}
  .tag-item{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:transparent;cursor:pointer;font-weight:600;font-size:13px;color:var(--text);transition:background var(--transition-fast)}
  .tag-item.sel{background:var(--accent);color:var(--text);border-color:var(--accent)}

  /* controls/buttons */
  .btn{padding:8px 10px;border-radius:6px;border:0;background:var(--accent);color:var(--text);cursor:pointer;font-weight:600}
  .btn.ghost{background:transparent;color:var(--link);border:1px solid var(--border)}
  .hide-btn{background:transparent;color:var(--text);padding:6px 8px;border-radius:6px;border:1px solid var(--border);cursor:pointer}

  /* right column */
  .col-right{width:var(--right-w);display:flex;flex-direction:column;gap:12px;transition:width var(--transition-fast) ease;}
  .col-right.full{width:100%}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px}

  /* inline panels */
  .panel-inline{display:none;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--card)}

  /* chat */
  .chat-panel{flex:1;display:flex;flex-direction:column;gap:12px;padding:12px;overflow:hidden;position:relative}
  .messages{flex:1;overflow:auto;display:flex;flex-direction:column;gap:12px;padding-right:4px}
  .msg-wrap{position:relative;display:flex;flex-direction:column;gap:6px}
  .message{max-width:75%;padding:10px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.03);background:var(--card);border:1px solid var(--border);color:var(--text);position:relative}
  .message.user{align-self:flex-end;border-top-right-radius:2px}
  .message.agent{align-self:flex-start;border-top-left-radius:2px}
  .msg-body{white-space:pre-wrap;min-height:10px}

  /* avatars outside bubbles */
  .avatar-agent, .avatar-user{
    width:var(--avatar-size);height:var(--avatar-size);border-radius:50%;position:absolute;bottom:-8px;box-shadow:0 1px 3px rgba(0,0,0,0.12);
  }
  .avatar-agent{left:-22px;background:#3030ff;border:2px solid var(--card)}
  .avatar-user{right:-22px;background:#1ee8b6;border:2px solid var(--card)}

  /* sticky input area */
  .controls-wrapper{position:sticky;bottom:12px;z-index:20;padding-top:8px;background:transparent}
  .controls{display:flex;gap:8px;align-items:center;padding:12px;background:var(--card);border-radius:8px;box-shadow:0 -3px 12px rgba(0,0,0,0.03);width:100%;border:1px solid var(--border)}
  .topic-cloud{display:flex;gap:8px;flex-wrap:wrap}
  .link-small{font-size:13px;color:var(--link);cursor:pointer;text-decoration:underline;background:none;border:0;padding:0}

  /* pdf dropzone */
  .pdf-dropzone{
    display:flex;align-items:center;justify-content:center;padding:12px;border-radius:8px;border:1px dashed var(--border);cursor:pointer;background:transparent;color:var(--text);
  }
  .pdf-dropzone.dragover{background:rgba(0,0,0,0.03)}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center;z-index:220}
  .modal{background:var(--card);border-radius:8px;padding:16px;max-width:90%;max-height:80%;overflow:auto;border:1px solid var(--border)}
  .modal pre{white-space:pre-wrap;word-break:break-word;background:transparent;padding:12px;border-radius:6px;font-size:13px;color:var(--text)}

  /* disclaimer */
  .disclaimer{font-size:12px;color:var(--text);opacity:0.9;margin-top:8px}

  @media (max-width:900px){
    header.appbar{position:relative}
    .app{flex-direction:column;height:auto}
    .col-left,.col-right{width:100%}
    .messages{padding-bottom:120px}
  }
</style>
</head>
<body>
<header class="appbar" role="banner">
  <div style="display:flex;align-items:center;gap:12px">
    <div class="app-title" id="appTitle">Your New Agent</div>
    <div id="appSubtitle" style="font-size:13px;color:var(--text);opacity:0.85"></div>
  </div>
  <div class="tools" role="toolbar" aria-label="Outils">
    <button id="modifyBtnTop" class="btn ghost">Modifier</button>
    <button id="shareBtn" class="btn ghost">Partager</button>
    <button id="settingsBtn" class="btn ghost">Réglages</button>
    <button id="subscriptionBtn" class="btn ghost">Abonnement</button>
    <button id="resetChatTop" class="btn ghost">Réinitialiser</button>
  </div>
</header>

<div class="app" id="appRoot">
  <!-- LEFT -->
  <div class="col-left hidden" id="leftCol">
    <div class="panel" id="resources-panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0;color:var(--text)">Ressources</h3>
        <div><button id="hideLeft" class="hide-btn">Masquer</button></div>
      </div>

      <div class="add-wrapper" id="addWrapper">
        <h4 id="addWrapperTitle">Ajouter une ressource</h4>
        <form id="addForm" class="add-resource-form" onsubmit="return false;">
          <label class="small">Type</label>
          <div id="typeTags" class="tag-cloud" role="radiogroup" aria-label="Type">
            <div class="tag-item sel" data-value="note">Note</div>
            <div class="tag-item" data-value="url">Lien</div>
            <div class="tag-item" data-value="pdf">PDF</div>
          </div>

          <label class="small">Catégorie</label>
          <div id="categoryTags" class="tag-cloud" role="radiogroup" aria-label="Category">
            <div class="tag-item sel" data-value="Help">Help</div>
            <div class="tag-item" data-value="Knowledge">Knowledge</div>
            <div class="tag-item" data-value="Process">Process</div>
            <div class="tag-item" data-value="How to">How to</div>
            <div class="tag-item" data-value="Other">Other</div>
          </div>

          <div id="inputNote">
            <label class="small">Titre</label>
            <input id="resTitle" placeholder="Titre bref" type="text"/>
            <label class="small">Contenu (texte)</label>
            <textarea id="resContent" placeholder="Collez un extrait..."></textarea>
          </div>

          <div id="inputUrl" style="display:none">
            <label class="small">URL</label>
            <input id="resUrl" placeholder="https://..." type="text"/>
            <label class="small">Contexte (description)</label>
            <input id="resUrlContext" placeholder="Description courte du lien" type="text"/>
          </div>

          <div id="inputPdf" style="display:none">
            <label class="small">PDF</label>
            <div id="pdfDropzone" class="pdf-dropzone">Cliquez ou déposez un fichier PDF ici</div>
            <input id="resPdfFile" type="file" accept="application/pdf" style="display:none"/>
          </div>

          <div style="display:flex;gap:8px;">
            <button type="button" id="addResBtn" class="btn">Ajouter</button>
            <button type="button" id="clearResBtn" class="btn ghost">Effacer</button>
          </div>
        </form>
      </div>

      <div class="resource-list" id="resourceList" aria-live="polite"></div>
    </div>
  </div>

  <!-- RIGHT -->
  <div class="col-right full" id="rightCol">
    <div class="panel-inline" id="sharePanel" aria-hidden="true" style="margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong id="shareTitle" style="color:var(--text)">Lien de partage</strong>
        <button id="closeShare" class="btn ghost">Fermer</button>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <input id="shareLink" readonly type="text" value="https://example.local/agent/xxxx" style="flex:1;background:transparent;color:var(--text);border:1px solid var(--border);padding:6px;border-radius:6px"/>
        <button id="copyShare" class="btn">Copier</button>
      </div>
    </div>

    <div class="panel-inline" id="settingsPanel" aria-hidden="true" style="margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong style="color:var(--text)">Réglages</strong><button id="closeSettings" class="btn ghost">Fermer</button>
      </div>
      <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
        <label class="small">Nom de l'agent</label>
        <input id="agentName" placeholder="Nom de l'agent" type="text" value="Your New Agent"/>

        <label class="small">Style (thème)</label>
        <div id="styleTags" class="tag-cloud">
          <div class="tag-item sel" data-value="Ice">Ice</div>
          <div class="tag-item" data-value="Bronze">Bronze</div>
          <div class="tag-item" data-value="Funky">Funky</div>
          <div class="tag-item" data-value="Serious Office">Serious Office</div>
        </div>

        <label class="small">Langue</label>
        <div id="langTags" class="tag-cloud">
          <div class="tag-item sel" data-value="fr">Français</div>
          <div class="tag-item" data-value="en">English</div>
        </div>

        <label class="small">Type</label>
        <div id="typeAgentTags" class="tag-cloud">
          <div class="tag-item sel" data-value="Interne">Interne</div>
          <div class="tag-item" data-value="Public">Public</div>
        </div>

        <label class="small">Email support</label>
        <input id="supportEmail" type="text" placeholder="support@exemple.com" />

        <label class="small">Tél support</label>
        <input id="supportTel" type="text" placeholder="+33 1 23 45 67 89" />

        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="saveSettings" class="btn">Sauvegarder</button>
        </div>
      </div>
    </div>

    <div class="panel-inline" id="subscriptionPanel" aria-hidden="true" style="margin-bottom:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong style="color:var(--text)">Abonnement</strong><button id="closeSubscription" class="btn ghost">Fermer</button>
      </div>
      <div style="margin-top:8px">
        <p class="small">Statut : <strong id="subStatus">Free (mock)</strong></p>
        <p class="small">Renouvellement : <strong id="subRenew">2025-12-01</strong></p>
        <div style="margin-top:8px"><button id="upgradeBtn" class="btn">Voir options</button></div>
      </div>
    </div>

    <div class="panel chat-panel" id="chatPanel">
      <div class="messages" id="messages" aria-live="polite"></div>

      <div class="controls-wrapper">
        <div class="controls" role="region" aria-label="Saisie">
          <input id="queryInput" type="text" placeholder="Posez votre question..." style="flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text)"/>
          <div style="display:flex;flex-direction:column;gap:6px;min-width:240px">
            <div class="small" style="color:var(--text)">Topic (optionnel)</div>
            <div id="topicCloud" class="topic-cloud">
              <div class="tag-item sel" data-value="">Aucun</div>
              <div class="tag-item" data-value="Help">Help</div>
              <div class="tag-item" data-value="Knowledge">Knowledge</div>
              <div class="tag-item" data-value="Process">Process</div>
              <div class="tag-item" data-value="How to">How to</div>
              <div class="tag-item" data-value="Other">Other</div>
            </div>
          </div>
          <button id="sendBtn" class="btn">Envoyer</button>
        </div>

        <div class="disclaimer" id="disclaimer"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal universal -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-hidden="true">
  <div class="modal" id="modalContent">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h4 id="modalTitle" style="margin:0;color:var(--text)">Source</h4>
      <button id="closeModal" class="btn ghost">Fermer</button>
    </div>
    <div id="modalBodyWrap" style="margin-top:12px">
      <pre id="modalBody" style="color:var(--text)"></pre>
    </div>
  </div>
</div>

<script>
/* PDF worker */
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.9.179/build/pdf.worker.min.js';

/* TRANSLATIONS */
const T = {
  fr: {
    modify: "Modifier",
    share: "Partager",
    settings: "Réglages",
    subscription: "Abonnement",
    reset: "Réinitialiser",
    add: "Ajouter",
    clear: "Effacer",
    addResourceTitle: "Ajouter une ressource",
    noAnswer: "Il semble que je n’ai pas la réponse à cette information.",
    informAgent: "Informer l’agent",
    helpLabel: "Aide",
    helpModalTitle: "Aide & contact",
    helpModalText: "L’auteur de l'agent vous suggère d'accéder à l'aide en utilisant ces coordonnées.",
    disclaimer: (agentName) => `${agentName} peut commettre des erreurs. Il est recommandé de vérifier les informations importantes. <a href="/terms">Conditions d’utilisation</a>. <a href="/support">Signaler un problème</a>.`,
    shareTitle: "Lien de partage",
    viewAll: "Voir tout",
    exportText: "Exporter texte",
    supportEmailLabel: "Email support",
    supportTelLabel: "Tél support",
    topicLabel: "Topic (optionnel)",
    agentPlaceholderQuestion: "Posez votre question..."
  },
  en: {
    modify: "Modify",
    share: "Share",
    settings: "Settings",
    subscription: "Subscription",
    reset: "Reset",
    add: "Add",
    clear: "Clear",
    addResourceTitle: "Add a resource",
    noAnswer: "It seems I don't have the answer to that information.",
    informAgent: "Inform the agent",
    helpLabel: "Help",
    helpModalTitle: "Help & contact",
    helpModalText: "The author of the agent suggests contacting support using these details.",
    disclaimer: (agentName) => `${agentName} may make mistakes. Please verify important information. <a href="/terms">Terms of use</a>. <a href="/support">Report a problem</a>.`,
    shareTitle: "Share link",
    viewAll: "View all",
    exportText: "Export text",
    supportEmailLabel: "Support email",
    supportTelLabel: "Support phone",
    topicLabel: "Topic (optional)",
    agentPlaceholderQuestion: "Ask your question..."
  }
};

/* THEMES */
const THEMES = {
  "Bronze": {
    "--bg":"#5c1500","--accent":"#751b02","--secondary":"#ff7a4a","--border":"#824e3d","--text":"#000000","--link":"#ff7a4a","--card":"#f7efe8","--contrast-bg":"#f6e6dd","--contrast-border":"#e0b89a"
  },
  "Ice": {
    "--bg":"#f5f6fa","--accent":"#cad0db","--secondary":"#1179cf","--border":"#a9b4c7","--text":"#3b4f73","--link":"#1179cf","--card":"#ffffff","--contrast-bg":"#eef3fb","--contrast-border":"#d7e1ee"
  },
  "Funky": {
    "--bg":"#400d40","--accent":"#360c36","--secondary":"#1066a3","--border":"#664966","--text":"#cfc4cf","--link":"#1066a3","--card":"#2b122b","--contrast-bg":"#371233","--contrast-border":"#613a4e"
  },
  "Serious Office": {
    "--bg":"#4a3954","--accent":"#3a2a45","--secondary":"#02b1d9","--border":"#675d70","--text":"#d3ced6","--link":"#02b1d9","--card":"#3e3140","--contrast-bg":"#41323f","--contrast-border":"#5f5362"
  }
};

/* STATE */
const state = {
  resources: [],
  inverted: {},
  messages: [],
  resourceCounter: 0,
  settings: {
    name: 'Your New Agent',
    style: 'Ice',     // default theme Ice
    type: 'Interne',
    lang: 'fr',       // default FR
    supportEmail: '',
    supportTel: ''
  },
  ui: {
    selectedType: 'note',
    selectedCategory: 'Help',
    selectedTopic: '',
    leftVisible: false,
    latestUserQuestion: ''
  }
};

/* utilities */
function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function normalizeText(s){ return (s||'').trim().replace(/\s+/g,' ').toLowerCase(); }
function tokenize(s){ return normalizeText(s).split(/[^a-z0-9àâäéèêëîïôöùûüç'-]+/).filter(t=>t && t.length>1); }
function sentenceSplit(text){ const raw=(text||'').replace(/\r/g,' ').replace(/\n/g,' ').replace(/\s+/g,' '); const parts=raw.split(/(?<=[.?!])\s+/g); return parts.map(p=>p.trim()).filter(p=>p.length>10); }
function buildTf(tokens){ const tf={}; tokens.forEach(t=>tf[t]=(tf[t]||0)+1); const L=tokens.length||1; Object.keys(tf).forEach(k=>tf[k]=tf[k]/L); return tf; }
function scoreTf(tfQ, tfD){ let dot=0,nQ=0,nD=0; for(const k in tfQ) nQ+=tfQ[k]*tfQ[k]; for(const k in tfD) nD+=tfD[k]*tfD[k]; for(const k in tfQ) if(tfD[k]) dot+=tfQ[k]*tfD[k]; if(nQ===0||nD===0) return 0; return dot/(Math.sqrt(nQ)*Math.sqrt(nD)); }

/* apply theme */
function applyTheme(name){
  const map = THEMES[name];
  if(!map) return;
  const root = document.documentElement;
  Object.keys(map).forEach(k => root.style.setProperty(k, map[k]));
  // colors for dynamic elements
  document.body.style.background = getComputedStyle(root).getPropertyValue('--bg');
  // update visible elements styling if necessary
  document.querySelectorAll('.btn').forEach(b => b.style.color = getComputedStyle(root).getPropertyValue('--text'));
  document.querySelectorAll('.link-small').forEach(l => l.style.color = getComputedStyle(root).getPropertyValue('--link'));
  // update add-wrapper contrast (already uses CSS variables)
  document.getElementById('addWrapperTitle').style.color = getComputedStyle(root).getPropertyValue('--text');
}

/* tag cloud setup */
function setupTagCloud(id, initial, cb){
  const cont = document.getElementById(id);
  if(!cont) return;
  cont.querySelectorAll('.tag-item').forEach(el=>{
    el.addEventListener('click', ()=> {
      cont.querySelectorAll('.tag-item').forEach(s=>s.classList.remove('sel'));
      el.classList.add('sel');
      if(cb) cb(el.dataset.value);
    });
  });
  const sel = cont.querySelector('.tag-item[data-value="'+initial+'"]');
  if(sel){ cont.querySelectorAll('.tag-item').forEach(s=>s.classList.remove('sel')); sel.classList.add('sel'); }
}

/* resources */
function renderResources(){
  const cont = document.getElementById('resourceList'); cont.innerHTML = '';
  state.resources.forEach(r=>{
    const div = document.createElement('div'); div.className = 'resource-item';
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px">
        <div style="flex:1">
          <strong style="color:var(--text)">${escapeHtml(r.title || r.type)}</strong>
          <div class="meta"><span class="tag">${escapeHtml(r.category)}</span><span style="margin-left:8px;color:var(--text)">${escapeHtml(r.type.toUpperCase())}</span></div>
        </div>
        <div class="resource-controls"><button class="btn ghost" data-id="${r.id}" data-action="delete">${translate('clear')}</button></div>
      </div>
      <div class="small" style="color:var(--text)">${escapeHtml((r.rawText||'').substring(0,300))}${(r.rawText||'').length>300?'...':''}</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="link-small" data-id="${r.id}" data-action="view">${translate('viewAll')}</button>
        <button class="link-small" data-id="${r.id}" data-action="export">${translate('exportText')}</button>
      </div>`;
    cont.appendChild(div);
  });
}

/* add/delete resource */
function addResource(obj){
  const id = 'r'+(++state.resourceCounter);
  const sentences = sentenceSplit(obj.rawText||'').map(s=>{ const tokens=tokenize(s); return {text:s,tokens,tf:buildTf(tokens)}; }).filter(x=>x.tokens.length>0);
  const r = {id,type:obj.type,title:obj.title||obj.type,category:obj.category,rawText:obj.rawText,meta:obj.meta||{},sentences};
  state.resources.push(r);
  r.sentences.forEach(s=>s.tokens.forEach(t=>{ if(!state.inverted[t]) state.inverted[t]=new Set(); state.inverted[t].add(r.id); }));
  renderResources(); return r;
}
function deleteResource(id){ state.resources = state.resources.filter(r=>r.id!==id); renderResources(); }

/* fetch / pdf reading */
async function fetchUrlText(url){
  try{
    const resp = await fetch(url, {mode:'cors'});
    const ct = resp.headers.get('content-type') || '';
    if(ct.includes('text/html')){
      const html = await resp.text();
      const cleaned = html.replace(/<script[\s\S]*?<\/script>/gi,'').replace(/<style[\s\S]*?<\/style>/gi,'');
      const text = cleaned.replace(/<\/?[^>]+(>|$)/g,' ').replace(/\s+/g,' ');
      return text.substring(0,20000);
    } else return 'Contenu non-HTML récupéré depuis ' + url + ' (type: ' + ct + ').';
  }catch(e){ return 'ERREUR_FETCH: impossible de récupérer (CORS ou réseau) : ' + (e.message||e); }
}
async function readPdfFile(file){
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:arrayBuffer}).promise;
  let fullText = '';
  for(let i=1;i<=pdf.numPages;i++){
    try{ const page = await pdf.getPage(i); const txt = await page.getTextContent(); const t = txt.items.map(it => it.str).join(' '); fullText += t + ' '; }
    catch(err){ console.warn('pdf page read error',err); }
  }
  return fullText;
}

/* CHAT / retrieval (answer text does not include "Sources cited" string) */
function retrieveAnswer(question, chosenTopic){
  const qtokens = tokenize(question || '');
  const qtf = buildTf(qtokens);
  const candidates = [];
  state.resources.forEach(res=>{
    res.sentences.forEach(s=>{
      const sc = scoreTf(qtf, s.tf);
      candidates.push({score:sc,text:s.text,resource:res});
    });
  });
  candidates.sort((a,b)=>b.score-a.score);
  const top = candidates.slice(0,18).filter(c=>c.score>0);
  const bestScore = top.length ? top[0].score : 0;
  const threshold = 0.06;
  if(bestScore < threshold) return {found:false};
  const used = new Set(), snippets = [];
  for(const c of top){
    if(snippets.length>=8) break;
    const key = c.resource.id + '||' + c.text.slice(0,30);
    if(!used.has(key)){ snippets.push(c); used.add(key); }
  }
  const resourceIds = Array.from(new Set(snippets.map(s=>s.resource.id)));
  let answer = (chosenTopic ? ('Contexte (topic: ' + chosenTopic + ').\n\n') : '');
  snippets.forEach(s=>{ answer += '- ' + s.text + '\n'; });
  return {found:true,answer,resources:resourceIds};
}

/* typing function: types text into an element quickly, returns Promise */
function typeText(el, text, speed=12){
  return new Promise(resolve=>{
    let i=0;
    el.textContent = '';
    const iv = setInterval(()=>{ el.textContent += text.charAt(i); i++; if(i>=text.length){ clearInterval(iv); resolve(); } }, speed);
  });
}

/* appendMessage: no name/time in bubbles; for agent will type the text */
async function appendMessage(role, text, meta){
  const messagesDiv = document.getElementById('messages');
  const wrap = document.createElement('div'); wrap.className = 'msg-wrap';
  const el = document.createElement('div'); el.className = 'message ' + (role==='user' ? 'user' : 'agent');
  const body = document.createElement('div'); body.className = 'msg-body';
  el.appendChild(body);

  // append avatars outside bubbles
  if(role==='agent'){
    const avatar = document.createElement('div'); avatar.className = 'avatar-agent'; wrap.appendChild(avatar);
  } else {
    const avatar = document.createElement('div'); avatar.className = 'avatar-user'; wrap.appendChild(avatar);
  }

  wrap.appendChild(el);
  messagesDiv.appendChild(wrap);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  if(role==='agent'){
    // typing animation
    await typeText(body, text, 8); // speed param (lower = faster) => quick typing
    // show clickable sources (if any)
    if(meta && meta.resources && meta.resources.length){
      const sr = document.createElement('div'); sr.style.marginTop='8px';
      const list = document.createElement('div'); list.style.display='flex'; list.style.gap='8px'; list.style.flexWrap='wrap';
      meta.resources.forEach(rid=>{
        const r = state.resources.find(x=>x.id===rid);
        const btn = document.createElement('button'); btn.className='tag-item';
        btn.textContent = r ? (r.title || r.type) : rid;
        btn.addEventListener('click', ()=> openModalForResource(rid));
        list.appendChild(btn);
      });
      sr.appendChild(list); el.appendChild(sr);
    }
    // actions: Informer l'agent and Help
    const actions = document.createElement('div'); actions.style.marginTop='8px';
    const fb = document.createElement('button'); fb.className='link-small'; fb.textContent = translate('informAgent');
    fb.addEventListener('click', ()=> openFeedbackBlockWithQuestion(state.ui.latestUserQuestion));
    const hl = document.createElement('button'); hl.className='link-small'; hl.style.marginLeft='8px'; hl.textContent = translate('helpLabel');
    hl.addEventListener('click', ()=> openHelpModal());
    actions.appendChild(fb); actions.appendChild(hl); el.appendChild(actions);
  } else {
    // user: just show text, plus help? No extra actions
    body.textContent = text;
  }

  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  state.messages.push({role,text,meta,ts:Date.now()});
}

/* TRANSLATION helper */
function translate(key){ const lang = state.settings.lang || 'fr'; const dict = T[lang] || T['fr']; return dict[key] || key; }

/* UI wiring on DOMContentLoaded */
document.addEventListener('DOMContentLoaded', ()=>{

  /* tag clouds */
  setupTagCloud('typeTags', state.ui.selectedType, (v)=> {
    state.ui.selectedType = v;
    document.getElementById('inputNote').style.display = v==='note' ? 'block' : 'none';
    document.getElementById('inputUrl').style.display = v==='url' ? 'block' : 'none';
    document.getElementById('inputPdf').style.display = v==='pdf' ? 'block' : 'none';
  });
  setupTagCloud('categoryTags', state.ui.selectedCategory, (v)=> state.ui.selectedCategory = v);
  setupTagCloud('topicCloud', state.ui.selectedTopic || '', (v)=> state.ui.selectedTopic = v);
  setupTagCloud('styleTags', state.settings.style, (v)=> { state.settings.style = v; applyTheme(v); });
  setupTagCloud('typeAgentTags', state.settings.type, (v)=> state.settings.type = v);

  /* language tags */
  setupTagCloud('langTags', state.settings.lang, (v)=> {
    state.settings.lang = v;
    applyLanguage();
  });

  /* PDF dropzone wiring */
  const pdfDropzone = document.getElementById('pdfDropzone');
  const pdfInput = document.getElementById('resPdfFile');
  pdfDropzone.addEventListener('click', ()=> pdfInput.click());
  pdfDropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); pdfDropzone.classList.add('dragover'); });
  pdfDropzone.addEventListener('dragleave', ()=> pdfDropzone.classList.remove('dragover'));
  pdfDropzone.addEventListener('drop', (e)=>{ e.preventDefault(); pdfDropzone.classList.remove('dragover'); const f = e.dataTransfer.files[0]; if(f) pdfInput.files = e.dataTransfer.files; });

  /* panels */
  const sharePanel = document.getElementById('sharePanel');
  const settingsPanel = document.getElementById('settingsPanel');
  const subscriptionPanel = document.getElementById('subscriptionPanel');

  // SHARE btn (topbar)
  document.getElementById('shareBtn').addEventListener('click', ()=> {
    sharePanel.style.display = sharePanel.style.display==='block' ? 'none' : 'block';
    settingsPanel.style.display = 'none';
    subscriptionPanel.style.display = 'none';
  });
  document.getElementById('closeShare').addEventListener('click', ()=> sharePanel.style.display='none');
  document.getElementById('copyShare').addEventListener('click', ()=> { const link=document.getElementById('shareLink'); link.select(); document.execCommand('copy'); alert(state.settings.lang==='en' ? 'Link copied' : 'Lien copié'); });

  // SETTINGS
  document.getElementById('settingsBtn').addEventListener('click', ()=> {
    settingsPanel.style.display = settingsPanel.style.display==='block' ? 'none' : 'block';
    sharePanel.style.display='none';
    subscriptionPanel.style.display='none';
    // populate settings fields
    document.getElementById('agentName').value = state.settings.name;
    document.getElementById('supportEmail').value = state.settings.supportEmail || '';
    document.getElementById('supportTel').value = state.settings.supportTel || '';
    setupTagCloud('langTags', state.settings.lang, (v)=>{ state.settings.lang = v; applyLanguage(); });
  });
  document.getElementById('closeSettings').addEventListener('click', ()=> {
    state.settings.name = document.getElementById('agentName').value || state.settings.name;
    state.settings.supportEmail = document.getElementById('supportEmail').value || '';
    state.settings.supportTel = document.getElementById('supportTel').value || '';
    document.getElementById('appTitle').textContent = state.settings.name;
    applyTheme(state.settings.style);
    applyLanguage();
    settingsPanel.style.display='none';
  });

  // SUBSCRIPTION
  document.getElementById('subscriptionBtn').addEventListener('click', ()=> {
    subscriptionPanel.style.display = subscriptionPanel.style.display==='block' ? 'none' : 'block';
    sharePanel.style.display = 'none';
    settingsPanel.style.display = 'none';
  });
  document.getElementById('closeSubscription').addEventListener('click', ()=> subscriptionPanel.style.display='none');
  document.getElementById('upgradeBtn').addEventListener('click', ()=> alert(state.settings.lang==='en' ? 'Mock: upgrade options' : 'Mock : options de mise à niveau'));

  // Topbar modify / hide left
  const leftCol = document.getElementById('leftCol');
  const rightCol = document.getElementById('rightCol');
  const modifyBtnTop = document.getElementById('modifyBtnTop');
  const hideLeftBtn = document.getElementById('hideLeft');

  function showLeft(){ state.ui.leftVisible = true; leftCol.classList.remove('hidden'); rightCol.classList.remove('full'); modifyBtnTop.style.display='none'; }
  function hideLeft(){ state.ui.leftVisible = false; leftCol.classList.add('hidden'); rightCol.classList.add('full'); modifyBtnTop.style.display='inline-block'; }

  modifyBtnTop.addEventListener('click', showLeft);
  hideLeftBtn.addEventListener('click', hideLeft);
  // initial: left hidden
  hideLeft();

  /* Add resource handlers */
  document.getElementById('addResBtn').addEventListener('click', async ()=>{
    const type = state.ui.selectedType;
    const category = state.ui.selectedCategory;
    const title = document.getElementById('resTitle').value || '';
    if(type==='note'){
      const content = document.getElementById('resContent').value || '';
      if(!content.trim()){ alert(state.settings.lang === 'en' ? 'Please add text.' : 'Veuillez ajouter du texte.'); return; }
      addResource({type:'note',title,category,rawText:content,meta:{}});
      document.getElementById('resContent').value=''; document.getElementById('resTitle').value='';
    } else if(type==='url'){
      const url = document.getElementById('resUrl').value.trim();
      const ctx = document.getElementById('resUrlContext').value.trim();
      if(!url){ alert(state.settings.lang === 'en' ? 'URL missing' : 'URL manquante'); return; }
      const stub = addResource({type:'url',title: title||url,category,rawText: ctx ? (ctx + '\n\n' + url) : url,meta:{url,context:ctx}});
      try{
        const text = await fetchUrlText(url);
        stub.rawText += '\n\n' + text;
        stub.sentences = sentenceSplit(stub.rawText).map(s=>({text:s,tokens:tokenize(s),tf:buildTf(tokenize(s))}));
        stub.sentences.forEach(s=>s.tokens.forEach(t=>{ if(!state.inverted[t]) state.inverted[t]=new Set(); state.inverted[t].add(stub.id); }));
        renderResources();
      }catch(err){ stub.rawText += '\n\n' + ('Erreur: '+(err.message||err)); renderResources(); }
      document.getElementById('resUrl').value=''; document.getElementById('resUrlContext').value='';
    } else if(type==='pdf'){
      const fileInput = document.getElementById('resPdfFile');
      if(!fileInput.files || fileInput.files.length===0){ alert(state.settings.lang === 'en' ? 'Choose a PDF' : 'Choisissez un PDF'); return; }
      const file = fileInput.files[0];
      const stub = addResource({type:'pdf',title: title||file.name,category,rawText:'(lecture PDF en cours: '+file.name+')',meta:{fileName:file.name}});
      try{
        const text = await readPdfFile(file);
        stub.rawText = text || '(PDF sans texte)';
        stub.sentences = sentenceSplit(stub.rawText).map(s=>({text:s,tokens:tokenize(s),tf:buildTf(tokenize(s))}));
        stub.sentences.forEach(s=>s.tokens.forEach(t=>{ if(!state.inverted[t]) state.inverted[t]=new Set(); state.inverted[t].add(stub.id); }));
        renderResources();
      }catch(err){ stub.rawText = 'ERREUR PDF: '+(err.message||err); renderResources(); }
      fileInput.value='';
    }
  });

  /* resource list events */
  document.getElementById('resourceList').addEventListener('click', (e)=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const id = btn.dataset.id;
    const action = btn.dataset.action;
    if(action==='delete'){ if(confirm(state.settings.lang==='en' ? 'Delete resource?' : 'Supprimer cette ressource ?')) deleteResource(id); }
    else if(action==='view'){ openModalForResource(id); }
    else if(action==='export'){ const r = state.resources.find(x=>x.id===id); if(!r) return; const blob = new Blob([r.rawText], {type:'text/plain;charset=utf-8'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = (r.title||r.id)+'.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
  });

  /* clear form */
  document.getElementById('clearResBtn').addEventListener('click', ()=> { document.getElementById('resTitle').value=''; document.getElementById('resContent').value=''; document.getElementById('resUrl').value=''; document.getElementById('resUrlContext').value=''; document.getElementById('resPdfFile').value=''; });

  /* send (user question) */
  document.getElementById('sendBtn').addEventListener('click', async ()=> {
    const q = document.getElementById('queryInput').value.trim();
    if(!q) return;
    state.ui.latestUserQuestion = q;
    await appendMessage('user', q);
    document.getElementById('queryInput').value='';
    const res = retrieveAnswer(q, state.ui.selectedTopic);
    if(!res.found){ await appendMessage('agent', translate('noAnswer')); return; }
    await appendMessage('agent', res.answer, {resources: res.resources});
  });
  document.getElementById('queryInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); document.getElementById('sendBtn').click(); } });

  /* reset top */
  document.getElementById('resetChatTop').addEventListener('click', ()=> {
    if(confirm(state.settings.lang==='en' ? 'Reset conversation?' : 'Réinitialiser la discussion ?')){ document.getElementById('messages').innerHTML=''; state.messages=[]; }
  });

  /* save settings */
  document.getElementById('saveSettings').addEventListener('click', ()=>{
    state.settings.name = document.getElementById('agentName').value || state.settings.name;
    state.settings.supportEmail = document.getElementById('supportEmail').value || '';
    state.settings.supportTel = document.getElementById('supportTel').value || '';
    document.getElementById('appTitle').textContent = state.settings.name;
    applyTheme(state.settings.style);
    applyLanguage();
    alert(state.settings.lang === 'en' ? 'Settings saved (local)' : 'Paramètres sauvegardés (local)');
    document.getElementById('settingsPanel').style.display='none';
  });

  /* help modal wiring */
  document.getElementById('closeModal').addEventListener('click', ()=> { document.getElementById('modalBackdrop').style.display='none'; });
  document.getElementById('modalBackdrop').addEventListener('click', (e)=>{ if(e.target === document.getElementById('modalBackdrop')) document.getElementById('modalBackdrop').style.display='none'; });

  /* initial theme and language apply */
  applyTheme(state.settings.style);
  applyLanguage();
}); /* DOMContentLoaded end */

/* open modal to show resource content */
function openModalForResource(id){
  const r = state.resources.find(x=>x.id===id);
  if(!r) return;
  document.getElementById('modalTitle').textContent = (r.title || r.type) + ' — ' + (r.category || '');
  document.getElementById('modalBody').textContent = r.rawText || '';
  document.getElementById('modalBackdrop').style.display = 'flex';
}

/* Feedback: open left, show add block, focus title and autopopulate content with question */
function openFeedbackBlockWithQuestion(question){
  const leftCol = document.getElementById('leftCol');
  const rightCol = document.getElementById('rightCol');
  const modifyBtnTop = document.getElementById('modifyBtnTop');
  leftCol.classList.remove('hidden'); rightCol.classList.remove('full'); modifyBtnTop.style.display='none';
  // autofocus title and populate content
  const titleEl = document.getElementById('resTitle');
  const contentEl = document.getElementById('resContent');
  titleEl.focus();
  titleEl.value = (question ? (question.length>60 ? question.substring(0,57)+'...' : question) : '');
  contentEl.value = question || '';
  // scroll to top of resources panel
  document.getElementById('resources-panel').scrollTop = 0;
}

/* Help modal: show support contact from settings */
function openHelpModal(){
  const lang = state.settings.lang || 'fr';
  const dict = T[lang];
  const title = dict.helpModalTitle;
  const text = dict.helpModalText;
  const email = state.settings.supportEmail || '';
  const tel = state.settings.supportTel || '';
  document.getElementById('modalTitle').textContent = title;
  const body = document.getElementById('modalBody');
  body.innerHTML = escapeHtml(text) + '\n\n';
  // remove previous controls
  const prev = document.getElementById('helpControls'); if(prev) prev.remove();
  const controls = document.createElement('div'); controls.id = 'helpControls'; controls.style.marginTop='12px';
  const btnEmail = document.createElement('button'); btnEmail.className='btn'; btnEmail.style.marginRight='8px'; btnEmail.textContent = (lang==='en' ? 'Email' : 'Email');
  btnEmail.onclick = ()=> { if(email) window.location.href = 'mailto:'+email; else alert(lang==='en' ? 'No email provided' : "Aucun email renseigné"); };
  const btnTel = document.createElement('button'); btnTel.className='btn'; btnTel.textContent = (lang==='en' ? 'Tel' : 'Tél');
  btnTel.onclick = ()=> { if(tel) window.location.href = 'tel:'+tel; else alert(lang==='en' ? 'No phone provided' : "Aucun numéro renseigné"); };
  controls.appendChild(btnEmail); controls.appendChild(btnTel);
  body.appendChild(controls);
  document.getElementById('modalBackdrop').style.display = 'flex';
}

/* apply language to UI strings */
function applyLanguage(){
  const lang = state.settings.lang || 'fr';
  document.getElementById('modifyBtnTop').textContent = translate('modify');
  document.getElementById('shareBtn').textContent = translate('share');
  document.getElementById('settingsBtn').textContent = translate('settings');
  document.getElementById('subscriptionBtn').textContent = translate('subscription');
  document.getElementById('resetChatTop').textContent = translate('reset');
  document.getElementById('addWrapperTitle').textContent = translate('addResourceTitle');
  document.getElementById('addResBtn').textContent = translate('add');
  document.getElementById('clearResBtn').textContent = translate('clear');
  document.getElementById('shareTitle').textContent = translate('shareTitle');
  document.getElementById('queryInput').placeholder = translate('agentPlaceholderQuestion');
  renderResources();
  document.getElementById('disclaimer').innerHTML = (T[lang].disclaimer)(state.settings.name || 'Agent');
}

/* translate helper */
function translate(key){ const lang = state.settings.lang || 'fr'; const dict = T[lang] || T['fr']; return dict[key] || key; }

/* expose for debug */
window.miniIA = { state, addResource, retrieveAnswer, renderResources, applyTheme, applyLanguage };
</script>
</body>
</html>
