<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mini Chat IA local — Ressources user-driven</title>

<!-- PDF.js (pour lecture de PDF côté client) -->
<script src="https://unpkg.com/pdfjs-dist@3.9.179/build/pdf.min.js"></script>

<style>
  :root{
    --left-w: 30%;
    --right-w: 70%;
    --gap: 12px;
    --bg: #f6f7fb;
    --accent: #2b6ef6;
    --muted: #6b7280;
    --card: #ffffff;
    font-family: Inter, system-ui, Arial, sans-serif;
  }

  html,body{height:100%;margin:0;background:var(--bg);color:#111;}
  .app{
    display:flex;gap:var(--gap);padding:18px;height:100vh;box-sizing:border-box;
  }

  /* Left column (resources) */
  .col-left{
    width:var(--left-w);
    display:flex;flex-direction:column;gap:12px;
  }
  .panel{
    background:var(--card);border-radius:8px;padding:12px;box-shadow:0 1px 4px rgba(10,10,10,0.04);
    overflow:auto;
  }
  .panel h3{margin:0 0 8px 0;font-size:15px;}
  .add-resource-form{display:flex;flex-direction:column;gap:8px;}
  .row{display:flex;gap:8px;align-items:center;}
  input[type="text"], textarea, select {padding:8px;border:1px solid #e5e7eb;border-radius:6px;font-size:14px;width:100%;box-sizing:border-box;}
  textarea{min-height:80px;resize:vertical;}
  .btn{padding:8px 10px;border-radius:6px;border:0;background:var(--accent);color:white;cursor:pointer;font-weight:600;}
  .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(43,110,246,0.15);}
  .resource-list{display:flex;flex-direction:column;gap:8px;margin-top:8px;}
  .resource-item{border:1px dashed #e6e9ef;padding:8px;border-radius:6px;display:flex;flex-direction:column;gap:6px;}
  .meta{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
  .meta .tag{background:#eef2ff;color:var(--accent);padding:4px 8px;border-radius:999px;font-weight:600}
  .resource-controls{display:flex;gap:8px;margin-left:auto}
  .small{font-size:13px;color:var(--muted)}
  .feedback-block{display:none;padding:8px;border-radius:8px;background:#fff9f6;border:1px solid #ffe6d5}

  /* Right column (chat) */
  .col-right{width:var(--right-w);display:flex;flex-direction:column;gap:12px;}
  .topbar{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .share-panel{display:none;padding:8px;border-radius:6px;border:1px solid #e6e9ef;background:#fff}
  .chat-panel{flex:1;display:flex;flex-direction:column;gap:12px;padding:12px;overflow:auto}
  .messages{display:flex;flex-direction:column;gap:12px}
  .message{max-width:75%;padding:10px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,0.03)}
  .message.user{align-self:flex-end;background:#e6f0ff;color:#03326a}
  .message.agent{align-self:flex-start;background:#f3f4f6;color:#111}
  .message .meta-small{font-size:12px;color:var(--muted);margin-bottom:6px}
  .controls{display:flex;gap:8px;align-items:center;padding:12px;background:var(--card);border-radius:8px}
  .topic-select{width:220px}
  .share-link{display:flex;gap:8px;align-items:center}
  .suggestions{font-size:13px;color:var(--muted)}
  .action-buttons{display:flex;gap:8px;margin-top:6px}
  .link-small{font-size:13px;color:var(--accent);cursor:pointer;text-decoration:underline;background:none;border:0;padding:0}
  .rating-row{display:flex;gap:8px;align-items:center}
  .rating-star{cursor:pointer;padding:6px;border-radius:4px;border:1px solid #eee}
  .rating-star.sel{background:#ffedd5;border-color:#ffb86b}
  .transfer-btn{background:#ff4757;color:white}
  /* responsive */
  @media (max-width:900px){
    .app{flex-direction:column}
    .col-left,.col-right{width:100%}
  }
</style>
</head>
<body>
<div class="app">

  <!-- LEFT: Resources -->
  <div class="col-left">
    <div class="panel" id="resources-panel">
      <h3>Ressources (ajouter / gérer)</h3>

      <form id="addForm" class="add-resource-form">
        <label class="small">Type</label>
        <select id="resType">
          <option value="note">Note (texte)</option>
          <option value="url">Lien (URL)</option>
          <option value="pdf">Document PDF (upload)</option>
        </select>

        <label class="small">Catégorie</label>
        <select id="resCategory">
          <option>Help</option>
          <option>Knowledge</option>
          <option>Process</option>
          <option>How to</option>
          <option>Other</option>
        </select>

        <div id="inputNote">
          <label class="small">Titre</label>
          <input id="resTitle" placeholder="Titre bref (ex: FAQ sécurité)" type="text"/>
          <label class="small">Contenu (texte)</label>
          <textarea id="resContent" placeholder="Collez un paragraphe / note / extrait"></textarea>
        </div>

        <div id="inputUrl" style="display:none">
          <label class="small">URL</label>
          <input id="resUrl" placeholder="https://..." type="text"/>
        </div>

        <div id="inputPdf" style="display:none">
          <label class="small">Fichier PDF</label>
          <input id="resPdfFile" type="file" accept="application/pdf"/>
        </div>

        <div style="display:flex;gap:8px;">
          <button type="button" id="addResBtn" class="btn">Ajouter</button>
          <button type="button" id="clearResBtn" class="btn ghost">Effacer</button>
        </div>
      </form>

      <div id="feedbackInsert" class="feedback-block">
        <strong>Ajouter un item via feedback</strong>
        <p class="small">Notez l'agent (1-5) et éventuellement ajoutez une ressource pour l'améliorer.</p>
        <div class="row">
          <div class="rating-row" id="ratingRow">
            <span class="rating-star" data-v="1">1</span>
            <span class="rating-star" data-v="2">2</span>
            <span class="rating-star" data-v="3">3</span>
            <span class="rating-star" data-v="4">4</span>
            <span class="rating-star" data-v="5">5</span>
          </div>
        </div>
        <textarea id="feedbackNewResource" placeholder="Ajouter un extrait ou note qui aidera l'agent (optionnel)"></textarea>
        <div style="display:flex;gap:8px;">
          <button id="saveFeedbackRes" class="btn">Sauvegarder</button>
          <button id="cancelFeedback" class="btn ghost">Annuler</button>
        </div>
      </div>

      <div class="resource-list" id="resourceList" aria-live="polite">
        <!-- resources inserted here -->
      </div>
    </div>

    <!-- placeholder for other left-side content if needed -->
  </div>

  <!-- RIGHT: Chat -->
  <div class="col-right">
    <div class="topbar">
      <div style="display:flex;align-items:center;gap:8px">
        <h3 style="margin:0">Mini Chat IA (local)</h3>
        <div class="suggestions small">Répond uniquement depuis les ressources ajoutées.</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="shareBtn" class="btn ghost">Partager</button>
      </div>
    </div>

    <div class="share-panel panel" id="sharePanel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Lien de partage (temporaire)</strong></div>
        <div><button id="closeShare" class="btn ghost">Fermer</button></div>
      </div>
      <p class="small" style="margin-top:8px">Copiez ce lien pour partager : </p>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="shareLink" readonly type="text" value="https://example.local/agent/1234" />
        <button id="copyShare" class="btn">Copier</button>
      </div>
    </div>

    <div class="panel chat-panel">
      <div class="messages" id="messages">
        <!-- messages -->
      </div>

      <div class="controls" role="region" aria-label="Saisie de message">
        <input id="queryInput" type="text" placeholder="Posez votre question..." style="flex:1;padding:8px;border-radius:6px;border:1px solid #e6e9ef"/>
        <select id="topicSelect" class="topic-select">
          <option value="">-- Topic (optionnel) --</option>
          <option>Help</option>
          <option>Knowledge</option>
          <option>Process</option>
          <option>How to</option>
          <option>Other</option>
        </select>
        <button id="sendBtn" class="btn">Envoyer</button>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
        <button id="clearChat" class="btn ghost">Réinitialiser discussion</button>
      </div>
    </div>
  </div>
</div>

<script>
/*
  Mini chat IA local:
  - Stocke ressources (notes, URL, PDF text) en mémoire (session).
  - Indexe à la volée en phrases.
  - Recherche par similarité TF simple (bag-of-words + cosine-ish).
  - Assemble réponse à partir des phrases les plus pertinentes (maxTokens).
  - Si score trop bas => renvoie message "Je n'ai pas la réponse..." + boutons.

  Limitations :
  - Recherche basique (pas d'embeddings réels).
  - URL fetching dépend du CORS du site.
  - PDF parsing via PDF.js (peut être lent selon taille).
*/

pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.9.179/build/pdf.worker.min.js';

/* ---------- stockage en mémoire ---------- */
const state = {
  resources: [], // {id, type, title, category, rawText, meta:{url,fileName}, sentences: [{text, tokens, tf}]}
  inverted: {}, // for optional use
  messages: [], // chat messages [{role:'user'|'agent',text,ts}]
  resourceCounter: 0
};

/* ---------- utilitaires texte/simple tokenizer ---------- */
function normalizeText(s){
  return s.trim().replace(/\s+/g,' ').toLowerCase();
}
function tokenize(s){
  // simple split on non-word, remove tiny tokens
  return normalizeText(s).split(/[^a-z0-9àâäéèêëîïôöùûüç'-]+/).filter(t=>t && t.length>1);
}
function sentenceSplit(text){
  // naive split by punctuation.
  const raw = text.replace(/\r/g,' ').replace(/\n/g,' ').replace(/\s+/g,' ');
  const parts = raw.split(/(?<=[.?!])\s+/g);
  return parts.map(p=>p.trim()).filter(p=>p.length>10); // ignore very short
}

/* build TF map for tokens */
function buildTf(tokens){
  const tf = {};
  tokens.forEach(t=>tf[t]=(tf[t]||0)+1);
  // optionally normalize by length
  const L = tokens.length || 1;
  Object.keys(tf).forEach(k=>tf[k]=tf[k]/L);
  return tf;
}

/* cosine-like score between two tf maps */
function scoreTf(tfQ, tfDoc){
  // compute dot product of matching tokens
  let dot = 0;
  let normQ = 0, normD = 0;
  for(const k in tfQ){ normQ += tfQ[k]*tfQ[k]; }
  for(const k in tfDoc){ normD += tfDoc[k]*tfDoc[k]; }
  for(const k in tfQ){
    if(tfDoc[k]) dot += tfQ[k]*tfDoc[k];
  }
  if(normQ===0 || normD===0) return 0;
  return dot / (Math.sqrt(normQ)*Math.sqrt(normD));
}

/* ---------- resource management ---------- */

function renderResources(){
  const cont = document.getElementById('resourceList');
  cont.innerHTML = '';
  state.resources.forEach(r=>{
    const div = document.createElement('div');
    div.className = 'resource-item';
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px">
        <div style="display:flex;flex-direction:column">
          <strong>${escapeHtml(r.title || (r.type==='url'?r.meta.url:r.type.toUpperCase()))}</strong>
          <div class="meta">
            <span class="tag">${r.category}</span>
            <span>${r.type.toUpperCase()}</span>
            <span>${r.meta && r.meta.fileName?escapeHtml(r.meta.fileName):''}</span>
            <div class="resource-controls">
              <button class="btn ghost" data-id="${r.id}" data-action="delete">Supprimer</button>
            </div>
          </div>
        </div>
      </div>
      <div class="small">${escapeHtml(r.rawText.substring(0,300))}${r.rawText.length>300?'...':''}</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="link-small" data-id="${r.id}" data-action="view">Voir tout</button>
        <button class="link-small" data-id="${r.id}" data-action="export">Exporter texte</button>
      </div>
    `;
    cont.appendChild(div);
  });
}

/* escape helper */
function escapeHtml(s){
  if(!s) return '';
  return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

function addResource({type, title, category, rawText, meta}){
  const id = 'r'+(++state.resourceCounter);
  const sentences = sentenceSplit(rawText || '').map(s=>{
    const tokens = tokenize(s);
    return {text:s, tokens, tf: buildTf(tokens)};
  }).filter(x=>x.tokens.length>0);
  const resource = {id,type,title,category,rawText,meta,sentences};
  state.resources.push(resource);
  renderResources();
  indexInverted(resource);
  return resource;
}

function deleteResource(id){
  state.resources = state.resources.filter(r=>r.id!==id);
  renderResources();
}

/* Optional inverted index - simple token to resource ids */
function indexInverted(resource){
  resource.sentences.forEach(s=>{
    s.tokens.forEach(t=>{
      if(!state.inverted[t]) state.inverted[t]=new Set();
      state.inverted[t].add(resource.id);
    });
  });
}

/* Try fetch URL and extract basic text (CORS permitting) */
async function fetchUrlText(url){
  try{
    const resp = await fetch(url, {mode:'cors'});
    const ct = resp.headers.get('content-type') || '';
    if(ct.includes('text/html')){
      const html = await resp.text();
      // naive text extraction: strip tags
      const cleaned = html.replace(/<script[\s\S]*?<\/script>/gi,'').replace(/<style[\s\S]*?<\/style>/gi,'');
      const text = cleaned.replace(/<\/?[^>]+(>|$)/g, ' ').replace(/\s+/g,' ');
      return text.substring(0,20000); // limit
    } else {
      return `Contenu non-HTML récupéré depuis ${url} (type: ${ct}).`;
    }
  }catch(e){
    return `ERREUR_FETCH: impossible de récupérer (CORS ou réseau) : ${e.message||e}`;
  }
}

/* Read PDF file using PDF.js */
async function readPdfFile(file){
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data:arrayBuffer}).promise;
  let fullText = '';
  for(let i=1;i<=pdf.numPages;i++){
    try{
      const page = await pdf.getPage(i);
      const txt = await page.getTextContent();
      const t = txt.items.map(it => it.str).join(' ');
      fullText += t + ' ';
    }catch(err){
      console.warn('pdf page read error',err);
    }
  }
  return fullText;
}

/* ---------- chat & retrieval ---------- */

function appendMessage(role, text, meta = {}) {
  const messagesDiv = document.getElementById('messages');
  const el = document.createElement('div');
  el.className = 'message ' + (role==='user'?'user':'agent');
  const timeS = new Date().toLocaleTimeString();
  el.innerHTML = `<div class="meta-small">${role==='user'?'Vous':'Agent IA'} · ${timeS}</div><div>${escapeHtml(text).replace(/\n/g,'<br>')}</div>`;

  // if agent: add feedback small link & transfer buttons if needed.
  if(role==='agent'){
    const actions = document.createElement('div');
    actions.style.marginTop = '8px';
    actions.innerHTML = `<button class="link-small" data-action="feedback">Give feedback and improve accuracy</button>
                         <button class="link-small" data-action="transfer" style="margin-left:8px">Transfer to a human</button>`;
    el.appendChild(actions);
    // attach events
    actions.querySelector('[data-action="feedback"]').addEventListener('click',()=>openFeedbackBlock());
    actions.querySelector('[data-action="transfer"]').addEventListener('click',()=>transferToHuman());
  }

  messagesDiv.appendChild(el);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  state.messages.push({role,text,meta,ts:Date.now()});
}

/* retrieval: given question, return assembled answer from resources */
function retrieveAnswer(question, chosenTopic){
  const qnorm = normalizeText(question || '');
  const qtokens = tokenize(qnorm);
  const qtf = buildTf(qtokens);

  // Candidate sentences: gather from all resources (topic is only advisory)
  const candidates = [];
  state.resources.forEach(res=>{
    res.sentences.forEach(s=>{
      const sc = scoreTf(qtf, s.tf);
      candidates.push({score:sc, text:s.text, resource:res});
    });
  });

  // sort by score desc
  candidates.sort((a,b)=>b.score - a.score);

  // combine top N sentences with non-duplicated resource context
  const top = candidates.slice(0,14).filter(c=>c.score>0);
  const bestScore = top.length?top[0].score:0;

  // compute a simple threshold (empirical)
  const threshold = 0.06; // small, tuneable
  if(bestScore < threshold){
    return {found:false, bestScore, snippets: []};
  }

  // group and pick best per resource, but keep top overall
  const used = new Set();
  const snippets = [];
  for(const c of top){
    if(snippets.length>=6) break;
    const key = c.resource.id + '||' + c.text.slice(0,30);
    if(!used.has(key)){
      snippets.push({text:c.text, score:c.score, resource:c.resource});
      used.add(key);
    }
  }

  // build an answer: start with an intro referencing topic choice (advisory)
  let answer = '';
  if(chosenTopic){
    answer += `Contexte (topic demandé: ${chosenTopic}). Réponse basée sur les ressources fournies :\n\n`;
  } else {
    answer += `Réponse basée uniquement sur les ressources disponibles :\n\n`;
  }
  snippets.forEach((s, i)=>{
    answer += `- (${s.resource.title || s.resource.type}) ${s.text}\n`;
  });

  // add citation-like cues
  answer += `\nSources citées : ${[...new Set(snippets.map(s=>s.resource.title || s.resource.type))].join('; ')}.`;
  return {found:true, bestScore, snippets, answer};
}

/* sendHandler */
async function handleSend(){
  const q = document.getElementById('queryInput').value.trim();
  const topic = document.getElementById('topicSelect').value;
  if(!q) return;
  appendMessage('user', q);
  document.getElementById('queryInput').value = '';

  // simulate processing (synchronous)
  const res = retrieveAnswer(q, topic);
  if(!res.found){
    const noResp = "Il semble que je n’ai pas la réponse à cette information.";
    appendMessage('agent', noResp);
    // below: add action buttons (already added by appendMessage)
    return;
  }
  appendMessage('agent', res.answer);
}

/* feedback & transfer */
function openFeedbackBlock(){
  const fb = document.getElementById('feedbackInsert');
  fb.style.display = 'block';
  // scroll left column to top
  document.getElementById('resources-panel').scrollTop = 0;
}
function closeFeedbackBlock(){
  const fb = document.getElementById('feedbackInsert');
  fb.style.display = 'none';
  // clear fields
  document.getElementById('feedbackNewResource').value = '';
  const stars = document.querySelectorAll('#ratingRow .rating-star');
  stars.forEach(s=>s.classList.remove('sel'));
}
function transferToHuman(){
  // simple behaviour: append a message with "transfert"
  appendMessage('agent', "Transfert demandé : un humain va être contacté (simulation). Merci d'indiquer vos coordonnées dans une vraie implémentation.");
}

/* ---------- events ---------- */

document.getElementById('resType').addEventListener('change', (e)=>{
  const v = e.target.value;
  document.getElementById('inputNote').style.display = v==='note'?'block':'none';
  document.getElementById('inputUrl').style.display = v==='url'?'block':'none';
  document.getElementById('inputPdf').style.display = v==='pdf'?'block':'none';
});

document.getElementById('addResBtn').addEventListener('click', async ()=>{
  const type = document.getElementById('resType').value;
  const category = document.getElementById('resCategory').value;
  const title = document.getElementById('resTitle').value || '';
  if(type==='note'){
    const content = document.getElementById('resContent').value || '';
    if(!content.trim()){ alert('Veuillez ajouter du texte.'); return; }
    addResource({type:'note', title, category, rawText:content, meta:{}});
    // clear
    document.getElementById('resContent').value = '';
    document.getElementById('resTitle').value = '';
  } else if(type==='url'){
    const url = document.getElementById('resUrl').value.trim();
    if(!url){ alert('URL manquante'); return; }
    const stubTitle = title || url;
    // attempt fetch
    const placeholder = addResource({type:'url', title:stubTitle, category, rawText:`(récupération en cours: ${url})`, meta:{url}});
    try{
      const text = await fetchUrlText(url);
      // update resource
      placeholder.rawText = text;
      placeholder.sentences = sentenceSplit(text).map(s=>({text:s,tokens:tokenize(s),tf:buildTf(tokenize(s))}));
      indexInverted(placeholder);
      renderResources();
    }catch(err){
      placeholder.rawText = `Erreur lors de la récupération: ${err.message||err}`;
      renderResources();
    }
    document.getElementById('resUrl').value = '';
  } else if(type==='pdf'){
    const fileInput = document.getElementById('resPdfFile');
    if(!fileInput.files || fileInput.files.length===0){ alert('Choisissez un PDF'); return; }
    const file = fileInput.files[0];
    const titleLocal = title || file.name;
    const stub = addResource({type:'pdf', title:titleLocal, category, rawText:`(lecture PDF en cours: ${file.name})`, meta:{fileName:file.name}});
    try{
      const text = await readPdfFile(file);
      stub.rawText = text || '(PDF sans texte détectable)';
      stub.sentences = sentenceSplit(stub.rawText).map(s=>({text:s,tokens:tokenize(s),tf:buildTf(tokenize(s))}));
      indexInverted(stub);
      renderResources();
    }catch(err){
      stub.rawText = `ERREUR lecture PDF : ${err.message||err}`;
      renderResources();
    }
    fileInput.value = '';
  }
});

/* resource list click handling */
document.getElementById('resourceList').addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const id = btn.dataset.id;
  const action = btn.dataset.action;
  if(action==='delete') {
    if(confirm('Supprimer cette ressource ?')) deleteResource(id);
  } else if(action==='view'){
    const r = state.resources.find(x=>x.id===id);
    if(!r) return;
    alert(`Contenu intégral (${r.title}):\n\n` + r.rawText.slice(0,5000));
  } else if(action==='export'){
    const r = state.resources.find(x=>x.id===id);
    if(!r) return;
    // download as txt
    const blob = new Blob([r.rawText], {type:'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = (r.title||r.id)+'.txt';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
});

/* clear form */
document.getElementById('clearResBtn').addEventListener('click', ()=>{
  document.getElementById('resTitle').value = '';
  document.getElementById('resContent').value = '';
  document.getElementById('resUrl').value = '';
  document.getElementById('resPdfFile').value = '';
});

/* send and enter */
document.getElementById('sendBtn').addEventListener('click', handleSend);
document.getElementById('queryInput').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){
    e.preventDefault(); handleSend();
  }
});
document.getElementById('clearChat').addEventListener('click', ()=>{
  if(confirm('Réinitialiser la discussion ?')) {
    document.getElementById('messages').innerHTML = '';
    state.messages = [];
  }
});

/* share panel toggle */
document.getElementById('shareBtn').addEventListener('click', ()=>{
  const p = document.getElementById('sharePanel');
  if(p.style.display === 'block'){
    p.style.display = 'none';
    document.getElementById('shareBtn').textContent = 'Partager';
  } else {
    // generate a temporary share link (placeholder)
    const link = 'https://example.local/agent/' + Math.random().toString(36).slice(2,8);
    document.getElementById('shareLink').value = link;
    p.style.display = 'block';
    document.getElementById('shareBtn').textContent = 'Fermer';
  }
});
document.getElementById('closeShare').addEventListener('click', ()=>{
  document.getElementById('sharePanel').style.display = 'none';
  document.getElementById('shareBtn').textContent = 'Partager';
});
document.getElementById('copyShare').addEventListener('click', ()=>{
  const link = document.getElementById('shareLink');
  link.select(); link.setSelectionRange(0,99999);
  document.execCommand('copy');
  alert('Lien copié.');
});

/* feedback block handlers */
document.querySelectorAll('#ratingRow .rating-star').forEach(el=>{
  el.addEventListener('click', (ev)=>{
    const v = parseInt(el.dataset.v,10);
    document.querySelectorAll('#ratingRow .rating-star').forEach(s=>s.classList.toggle('sel', parseInt(s.dataset.v,10) <= v));
    el.dataset.selected = v;
  });
});
document.getElementById('saveFeedbackRes').addEventListener('click', ()=>{
  const ratingEl = Array.from(document.querySelectorAll('#ratingRow .rating-star')).find(s=>s.classList.contains('sel'));
  const rating = ratingEl ? parseInt(ratingEl.dataset.v,10) : null;
  const content = document.getElementById('feedbackNewResource').value.trim();
  if(!rating && !content){
    if(!confirm('Vous n\'avez pas donné de note ni ajouté de ressource. Continuer ?')) return;
  }
  if(content){
    addResource({type:'note', title:'Feedback resource', category:'Other', rawText:content, meta:{via:'feedback'}});
  }
  closeFeedbackBlock();
  alert('Merci pour votre feedback !');
});
document.getElementById('cancelFeedback').addEventListener('click', ()=>closeFeedbackBlock());

/* initial sample resources to show usage */
addResource({type:'note', title:'Guide sécurité', category:'Help', rawText:
`Pour utiliser l'extincteur : tirer la goupille, viser la base du feu et pulvériser en balayant. Ne pas utiliser sur équipements électriques sous tension sans protection.` , meta:{}});
addResource({type:'note', title:'Procédure backup', category:'Process', rawText:
`La procédure de backup se fait quotidiennement à 02:00. Les étapes : stop services, dump base, compresser, chiffrer, envoyer sur l'archive.` , meta:{}});

/* helper: escape on paste of long text? not needed */

/* small UX: clicking on messages' feedback should open the feedback panel automatically */
document.getElementById('messages').addEventListener('click', (e)=>{
  const a = e.target.closest('.link-small');
  if(!a) return;
  const act = a.dataset.action;
  if(act === 'feedback') openFeedbackBlock();
  if(act === 'transfer') transferToHuman();
});

/* expose some debug on window for dev */
window.miniIA = {
  state, addResource, retrieveAnswer, renderResources
};

</script>
</body>
</html>
